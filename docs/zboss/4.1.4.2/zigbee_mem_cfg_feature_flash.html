<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<title>Developing with ZBOSS for Zigbee : Zigbee stack flash usage configuration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="nordic.css" rel="stylesheet" type="text/css" />
<link rel="Shortcut icon" href="./favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%" class="blank">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Nordic Semiconductor" src="logo_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Developing with ZBOSS for Zigbee
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('zigbee_mem_cfg_feature_flash.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Zigbee stack flash usage configuration </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#zigbee_mem_cfg_feature_flash_amount">Amount of memory used</a></li>
<li class="level1"><a href="#zigbee_mem_cfg_feature_flash_size">Adjusting persistent data area</a></li>
</ul>
</div>
<div class="textblock"><p>Every Zigbee device uses a part of the internal flash memory to store data, which allows to restore its functionality after power cut.</p>
<p>The following data is stored inside the flash memory:</p><ul>
<li>Device configuration:<ul>
<li>stack profile</li>
<li>list of allowed channels</li>
<li>security settings</li>
</ul>
</li>
<li>Current network data:<ul>
<li>addresses of the network manager, Trust Center, and parent</li>
<li>network channel, PAN ID, assigned short address</li>
<li>network key, TC link key, install codes</li>
<li>neighbor table</li>
<li>EUI64 address resolution table</li>
<li>poll control intervals and timeout values</li>
</ul>
</li>
<li>Device diagnostic data:<ul>
<li>number of resets</li>
<li>number of join attempts</li>
<li>number of buffer allocation errors</li>
</ul>
</li>
<li>Common application settings:<ul>
<li>local binding table entries</li>
<li>binding table</li>
<li>group membership of every active endpoint</li>
<li>attribute reporting configuration</li>
<li>Green Power Proxy Basic (GPPB) data</li>
</ul>
</li>
<li>Cluster specific settings</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>The memory configuration must not be changed between firmware versions if the firmware is going to be upgraded using the OTA DFU.</dd></dl>
<h1><a class="anchor" id="zigbee_mem_cfg_feature_flash_amount"></a>
Amount of memory used</h1>
<p>The memory reserved for storing the data is divided into two virtual pages of the same size. By default, a single page size is set based on the size of the MCU flash memory.</p>
<p>The amount of data that is written by the Zigbee device depends on:</p><ul>
<li>its role inside the network,</li>
<li>the complexity of the application,</li>
<li>the exact number of entries in the tables of the device.</li>
</ul>
<p>All stored values are organized into datasets that can be updated. This organization affects the flash usage, because if a certain value changes, the whole dataset that contains its value must be updated. The following table contains the list of the defined datasets, their sizes, and the device types for which these datasets are relevant.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Dataset size [bytes] </th><th class="markdownTableHeadNone">Dataset name </th><th class="markdownTableHeadNone">Device type  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">24 </td><td class="markdownTableBodyNone">NVRAM page header. </td><td class="markdownTableBodyNone">All devices.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">144 </td><td class="markdownTableBodyNone">Common dataset (device configuration, network data). </td><td class="markdownTableBodyNone">All devices.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">28 </td><td class="markdownTableBodyNone">Counters (NIB, AIB versions). </td><td class="markdownTableBodyNone">All devices.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">24 + 16 * ZB_CONFIG_IEEE_ADDR_TABLE_SIZE </td><td class="markdownTableBodyNone">EUI64 address map. </td><td class="markdownTableBodyNone">All devices.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">24 + 8 * ZB_CONFIG_NEIGHBOR_TABLE_SIZE </td><td class="markdownTableBodyNone">Neighbor table. </td><td class="markdownTableBodyNone">All devices.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">24 + 28 * ZB_CONFIG_N_APS_KEY_PAIR_ARR_MAX_SIZE </td><td class="markdownTableBodyNone">APS link keys (e.g. TC link key). </td><td class="markdownTableBodyNone">All devices.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">20 + 28 * n_install_codes </td><td class="markdownTableBodyNone">Install codes. </td><td class="markdownTableBodyNone">All devices.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">60 </td><td class="markdownTableBodyNone">GPPB cluster data. </td><td class="markdownTableBodyNone">Coordinator and routers.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">20 + 56 * n_gppb_pt_entries </td><td class="markdownTableBodyNone">GPPB proxy table. </td><td class="markdownTableBodyNone">Coordinator and routers.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">44 </td><td class="markdownTableBodyNone">HA dataset (poll control, diagnostic data). </td><td class="markdownTableBodyNone">Application-specific.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">24 + 12 * n_groups </td><td class="markdownTableBodyNone">APS group table. </td><td class="markdownTableBodyNone">Application-specific.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">20 + 24 * n_report_info </td><td class="markdownTableBodyNone">Attribute reporting configuration. </td><td class="markdownTableBodyNone">Application-specific.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">24 + binding_table_size </td><td class="markdownTableBodyNone">Local binding table. </td><td class="markdownTableBodyNone">Application-specific.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">44 </td><td class="markdownTableBodyNone">Poll Control cluster data. </td><td class="markdownTableBodyNone">Application-specific.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">56 + aps_ack_exempt_table_size + aps_link_key_authorization_table_size + use_trust_center_for_cluster_table_size </td><td class="markdownTableBodyNone">WWAH cluster data. </td><td class="markdownTableBodyNone">Application-specific.  </td></tr>
</table>
<center><b>Defined dataset sizes and device types</b></center><dl class="section note"><dt>Note</dt><dd><ul>
<li>The <code>n_install_codes</code> variable must be equal to <code>OVERALL_NETWORK_SIZE</code> for the coordinator node and to <code>2</code> for other devices.</li>
<li>The <code>n_gppb_pt_entries</code> value ranges from <code>0</code> to <code>5</code> and is the number of entries in GPPB proxy table.</li>
<li>The value of <code>n_report_info</code> must be equal to the amount of reportable attributes in your application (see cluster description in the ZCL specification).</li>
<li>Use the following formula to calculate maximum value of <code>binding_table_size:</code> ZB_CONFIG_APS_SRC_BINDING_TABLE_SIZE * 4 + ZB_CONFIG_APS_DST_BINDING_TABLE_SIZE * 8</li>
<li>All the data tables of WWAH cluster are aligned before writing to the NVRAM.</li>
</ul>
</dd></dl>
<p>The following table shows the estimates for the minimum value of flash memory that is written for a Zigbee device. It assumes that the network consists of two nodes.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">ZC/ZR Dataset size [bytes] </th><th class="markdownTableHeadNone">ZED Dataset size [bytes] </th><th class="markdownTableHeadNone">Dataset name </th><th class="markdownTableHeadNone">Note  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">24 </td><td class="markdownTableBodyNone">24 </td><td class="markdownTableBodyNone">NVRAM page header. </td><td class="markdownTableBodyNone">Every virtual page starts with a header.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">144 </td><td class="markdownTableBodyNone">144 </td><td class="markdownTableBodyNone">Common dataset (device configuration, network data). </td><td class="markdownTableBodyNone">-  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">28 </td><td class="markdownTableBodyNone">28 </td><td class="markdownTableBodyNone">Counters (NIB, AIB versions). </td><td class="markdownTableBodyNone">-  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">24 + 16 </td><td class="markdownTableBodyNone">24 + 16 </td><td class="markdownTableBodyNone">EUI64 address map. </td><td class="markdownTableBodyNone">At least one for the parent device.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">24 + 8 </td><td class="markdownTableBodyNone">24 + 8 </td><td class="markdownTableBodyNone">Neighbor table. </td><td class="markdownTableBodyNone">At least one for the parent device.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">24 + 56 </td><td class="markdownTableBodyNone">24 + 56 </td><td class="markdownTableBodyNone">APS link keys (e.g. TC link key). </td><td class="markdownTableBodyNone">At least two - provisional and verified.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">20 + 28 </td><td class="markdownTableBodyNone">20 + 28 </td><td class="markdownTableBodyNone">Install codes. </td><td class="markdownTableBodyNone">If the device uses install codes for commissioning (recommended).  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">60 </td><td class="markdownTableBodyNone">- </td><td class="markdownTableBodyNone">GPPB cluster data. </td><td class="markdownTableBodyNone">Mandatory for the coordinator and routers.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">20 </td><td class="markdownTableBodyNone">- </td><td class="markdownTableBodyNone">GPPB proxy table. </td><td class="markdownTableBodyNone">Mandatory for the coordinator and routers, but without GP devices in the network.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">44 </td><td class="markdownTableBodyNone">44 </td><td class="markdownTableBodyNone">HA dataset (poll control, diagnostic data). </td><td class="markdownTableBodyNone">Application-specific.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">24 + 0 </td><td class="markdownTableBodyNone">24 + 0 </td><td class="markdownTableBodyNone">APS group table. </td><td class="markdownTableBodyNone">Application does not use APS groups.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">20 + 0 </td><td class="markdownTableBodyNone">20 + 0 </td><td class="markdownTableBodyNone">Attribute reporting configuration. </td><td class="markdownTableBodyNone">Application does not have reportable attributes.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">24 </td><td class="markdownTableBodyNone">24 </td><td class="markdownTableBodyNone">Local binding table. </td><td class="markdownTableBodyNone">Low traffic, empty binding table.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><em>Total: 588 bytes</em> </td><td class="markdownTableBodyNone"><em>Total: 508 bytes</em> </td><td class="markdownTableBodyNone">- </td><td class="markdownTableBodyNone">-  </td></tr>
</table>
<center><b>Flash memory minimum value estimates</b></center><p>To estimate the required amount of flash memory, you can use the value calculated above as the base. Add more entries of the application-specific datasets and, depending on your application:</p><ul>
<li>on the coordinator node: at least 76 bytes for every additional node in the network,</li>
<li>on router nodes: at least 20 bytes for every additional node in the network.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>If the current virtual flash page is filled up with data, every valid dataset must be rewritten into a second page. Because of this, the minimal virtual page size must be greater than the amount of stored data multiplied by 4.</li>
<li>Recommended: Use larger virtual pages than calculated for a particular network to reduce the amount of flash erase cycles and extend the device lifetime.</li>
</ul>
</dd></dl>
<h1><a class="anchor" id="zigbee_mem_cfg_feature_flash_size"></a>
Adjusting persistent data area</h1>
<p>In nRF Connect SDK, the ZBOSS persistent data area is adjusted automatically by the <a href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/scripts/partition_manager/partition_manager.html" target="_blank">Partition Manager</a>. However, you can define the size of partitions by modifying the following Zephyr subsystem configurations in Partition Manager:</p><ul>
<li>NVS_STORAGE</li>
<li>ZBOSS_NVRAM</li>
<li>ZBOSS_PROD_CONFIG</li>
</ul>
<p>It is recommended to keep the default size of both ZBOSS partitions.</p>
<p>The persistent data is by default stored close to the end of flash memory. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="nav-path" class="topicfooter">
<a href="mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback" id="maillink">Documentation feedback</a> | <a href="https://devzone.nordicsemi.com/questions/" target="_blank">Developer Zone</a> | <a href="http://response.nordicsemi.com/subscribe-to-our-newsletters" target="_blank">Subscribe</a> | Updated <span id="date"/>
<script>
var date = new Date("Thu Nov 14 2024" + " UTC");
document.getElementById("date").innerHTML = date.toJSON().slice(0, 10);
var url=window.location.href.split("?")[0];
var filename=url.substring(url.lastIndexOf('/')+1);
document.getElementById("maillink").href = "mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback"+decodeURIComponent("%26")+"body=File%20name%3A%20"+encodeURIComponent(filename);
</script>
</div>
</body>
</html>
